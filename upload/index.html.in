<!DOCTYPE html>
<html>
    <head>
        <title>Upload To Hatrac</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
        <script type="text/javascript" src="sparkMD5.min.js"></script>
        <script type="text/javascript" src="hatrac.js"></script>
    </head>
    <body>
        <p>
            Select file and press upload<input type="file" id="file">
            <button id="upload" onclick="upload()">Upload</button>
        </p>
        <p>
            <button style="display: none;" id="pause" onclick="pause()">Pause</button>
            <button style="display: none;" id="resume" onclick="resume()">Resume</button>
            <button style="display: none;" id="restart" onclick="restart()">Restart</button>
            <button style="display: none;" id="cancel" onclick="cancel()">Cancel</button>
        </p>
        <p> 
            <b>Checksum calculation progress</b><br>
            <progress id="checksum_progress" value="0" ></progress>
            <br>
            <b>Upload progress</b><br>
            <progress id="summed_progress" value="0" ></progress>
        </p>
        
        <script>
                var hatracUpload = null;

                $('#file').change(function() {
                    if ($(this).val() != '') {
                        $('#pause').hide();
                        $('#cancel').hide();
                        $('#resume').hide();
                        $('#restart').hide();
                        $('#upload').show();
                    }
                });

                function pause() {
                    $('#pause').hide();
                    $('#cancel').show();
                    $('#resume').show();
                    $('#restart').hide();
                    hatracUpload.pause();
                }

                function resume() {
                    $('#pause').show();
                    $('#cancel').show();
                    $('#resume').hide();
                    $('#restart').hide();
                    hatracUpload.resume();
                }

                function cancel() {
                    $('#pause').hide();
                    $('#cancel').hide();
                    $('#resume').hide();
                    $('#restart').show();
                    $('#upload').show();
                    $('#file').removeAttr('disabled');
                    hatracUpload.cancel();
                }

                function restart() {
                    $('#pause').show();
                    $('#cancel').show();
                    $('#resume').hide();
                    $('#restart').hide();
                    hatracUpload.start(); 
                }

                function upload(user, pass) {
                    if (!(window.File && window.FileReader && window.FileList && window.Blob && window.Blob.prototype.slice)) {
                        alert("Sorry! You are using an older or unsupported browser. Please update your browser");
                        return;
                    }

                    var file = $('#file')[0].files[0];
                    hatracUpload = new hatrac.Upload(file, { url: "https://dev.isrd.isi.edu/hatrac/test" });

                    $('#upload').hide();
                    $('#file').attr('disabled', 'disabled');

                    hatracUpload.onServerError = function(command, jqXHR, textStatus, errorThrown) {
                        $('#pause').hide();
                        $('#cancel').hide();
                        $('#resume').hide();
                        $('#restart').show();
                        $('#upload').show();
                        $('#file').removeAttr('disabled');
                        if (jqXHR.status === 401) {
                            alert("Sorry you are not allowed to upload:" + xhr.responseText);
                        } else {
                            alert(jqXHR.status + "  " + errorThrown);
                            console.log("Our server is not responding correctly");
                        }
                    };

                    hatracUpload.onUploadError = function(xhr) {
                        $('#pause').hide();
                        $('#cancel').hide();
                        $('#resume').hide();
                        $('#restart').show();
                        $('#upload').show();
                        $('#file').removeAttr('disabled');
                        if (xhr.status === 401) {
                            alert("Sorry you are not allowed to upload : " + xhr.responseText);
                        } else {
                            alert(xhr.status + "  " + xhr.responseText);
                        }
                    };

                    hatracUpload.onError = function(err) {
                        $('#pause').hide();
                        $('#cancel').hide();
                        $('#resume').hide();
                        $('#restart').hide();
                        $('#upload').show();
                        $('#file').removeAttr('disabled');
                        alert(err.message);
                    };

                    hatracUpload.onChecksumProgressChanged = function(uploadedSize, totalSize) {
                        $('#checksum_progress').attr('value', uploadedSize);
                        $('#checksum_progress').attr('max', totalSize);

                        if (uploadedSize >= totalSize) {
                            $('#pause').show();
                            $('#cancel').show();
                        }
                    };

                    hatracUpload.onProgressChanged = function(uploadedSize, totalSize) {
                        $('#summed_progress').attr('value', uploadedSize);
                        $('#summed_progress').attr('max', totalSize);
                    };

                    hatracUpload.onUploadCompleted = function(url) {
                        hatracUpload = null;
                        alert("Congratz, upload is complete now \n" + url);

                        $('#file').val("");
                        $('#pause').hide();
                        $('#cancel').hide();
                        $('#resume').hide();
                        $('#restart').hide();
                        $('#upload').show();
                        $('#file').removeAttr('disabled');
                    };

                    hatracUpload.start();
                }
        </script>
    </body>
</html>