<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>HuBMAP CCF Registration User Interface (CCF-RUI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link href="dist/rui/styles.css" rel="stylesheet">
  <script src="dist/rui/wc.js" async></script>
</head>

<body class="mat-typography">
  <ccf-rui></ccf-rui>

  <script>
    const IN_IFRAME = window.self !== window.parent;

    // fields that we are going to send to chaise
    const FIELD_NAMES = {
      FILE: 'hra_file',
      ID: 'hra_id',
      CREATOR: 'hra_creator',
      ORGAN: 'hra_organ',
      SEX: 'hra_sex',
      ANNOTATIONS: 'hra_annotations'
    }

    // list of organs that we support.
    const ORGAN_LOOKUP = {
      'http://purl.org/ccf/latest/ccf.owl#VHFLeftKidneyV1.1': {
        'rui': {
          'name': 'kidney',
          'side': 'left',
          'sex': 'female'
        },
        'chaise': {
          'name': 'left kidney',
          'sex': 'Female'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHMLeftKidney': {
        'rui': {
          'name': 'kidney',
          'side': 'left',
          'sex': 'male'
        },
        'chaise': {
          'name': 'left kidney',
          'sex': 'Male'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHFRightKidneyV1.1': {
        'rui': {
          'name': 'kidney',
          'side': 'right',
          'sex': 'female'
        },
        'chaise': {
          'name': 'right kidney',
          'sex': 'Female'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHMRightKidney': {
        'rui': {
          'name': 'kidney',
          'side': 'right',
          'sex': 'male'
        },
        'chaise': {
          'name': 'right kidney',
          'sex': 'Male'
        }
      },
      "http://purl.org/ccf/latest/ccf.owl#VHMProstate": {
        'rui': {
          'name': 'prostate',
          'sex': 'male'
        },
        'chaise': {
          'name': 'prostate',
          'sex': 'Male'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHFLeftUreter': {
        'rui': {
          'name': 'ureter',
          'side': 'left',
          'sex': 'female'
        },
        'chaise': {
          'name': 'left ureter',
          'sex': 'Female'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHMLeftUreter': {
        'rui': {
          'name': 'ureter',
          'side': 'left',
          'sex': 'male'
        },
        'chaise': {
          'name': 'left ureter',
          'sex': 'Male'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHFRightUreter': {
        'rui': {
          'name': 'ureter',
          'side': 'right',
          'sex': 'female'
        },
        'chaise': {
          'name': 'right ureter',
          'sex': 'Female'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHMRightUreter': {
        'rui': {
          'name': 'ureter',
          'side': 'right',
          'sex': 'Male'
        },
        'chaise': {
          'name': 'right ureter',
          'sex': 'Male'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHFUterus': {
        'rui': {
          'name': 'uterus',
          'sex': 'female'
        },
        'chaise': {
          'name': 'uterus',
          'sex': 'Female'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHFUrinaryBladder': {
        'rui': {
          'name': 'urinary bladder',
          'sex': 'female'
        },
        'chaise': {
          'name': 'urinary bladder',
          'sex': 'Female'
        }
      },
      'http://purl.org/ccf/latest/ccf.owl#VHMUrinaryBladder': {
        'rui': {
          'name': 'urinary bladder',
          'sex': 'male'
        },
        'chaise': {
          'name': 'urinary bladder',
          'sex': 'Male'
        }
      }
    };

    /**
     * expected data structure of content:
     * {
     *  values
     * }
     */
    const configureRUI = (existingValue) => {
      const rui = document.querySelector('ccf-rui');

      let ruiPath = 'dist/rui/';
      // if (!window.location.pathname.endsWith('/')) {
      //   ruiPath = '/' + ruiPath;
      // }
      rui.baseHref = '/~ashafaei/ccf-ui/' + ruiPath;

      // hide the default header
      rui.header = false;

      rui.useDownload = !IN_IFRAME;
      if (IN_IFRAME) {
        rui.register = handleRegister;
      }


      if (existingValue && typeof existingValue[FIELD_NAMES.FILE] === 'string' && existingValue[FIELD_NAMES.FILE] !== '') {
        fetchExistingData(existingValue[FIELD_NAMES.FILE], rui);
      } else {
        dispatchMessage('iframe-data-ready');
      }
    }

    /**
     * this callback is called when users submit the form.
     * it will take care of verification and sending data to th eparent.
     */
    const handleRegister = (data) => {
      const dataObject = JSON.parse(data);

      // check the organ and make sure we're supporting it.
      let organID;
      if (dataObject['placement'] && dataObject['placement']['target']) {
        organID = dataObject['placement']['target'];
      }

      if (!(organID in ORGAN_LOOKUP)) {
        dispatchMessage('show-alert', { type: 'error', message: 'Please select another organ. We currently do not support the chosen organ.' });
        return;
      }

      const organObject = ORGAN_LOOKUP[organID].chaise;

      // turn the data into a file blob
      const blob = new Blob([JSON.stringify(dataObject, null, 2)], { type: 'application/json' });
      let fileName = 'HRA.json';
      if (organID.indexOf('#') !== -1) {
        fileName = 'HRA_' + organID.slice(organID.indexOf('#')+1) + '.json';
      }
      const file = new File([blob], fileName, { type: 'application/json' });

      const submittedData = {};
      submittedData[FIELD_NAMES.FILE] = file;
      submittedData[FIELD_NAMES.ID] = dataObject['@id'];
      submittedData[FIELD_NAMES.CREATOR] = dataObject['creator'];
      submittedData[FIELD_NAMES.SEX] = organObject.sex;
      submittedData[FIELD_NAMES.ORGAN] = organObject.name;

      // optional
      if (Array.isArray(dataObject['ccf_annotations']) && dataObject['ccf_annotations'].length > 0) {
        // chaise expects the value to be a string that will parse to json
        // TODO test array of text
        submittedData[FIELD_NAMES.ANNOTATIONS] = dataObject['ccf_annotations'];
      }

      dispatchMessage('submit-data', submittedData);
    }

    /**
     * if a value is already selected, we should fetch the file and
     * get the json from it.
     *
     */
    const fetchExistingData = (fileURL, rui) => {
      fetch(fileURL).then(response => {
        if (response.ok) {
          return response.json();
        } else {
          console.log(response.body);
          throw new Erorr('couldn\'t fetch the file');
        }
      }).then(data => {
        // preselect the user info
        if (data && data.creator_first_name && data.creator_last_name) {
          rui.user = { firstName: data.creator_first_name, lastName: data.creator_last_name };
        }

        // preselect the organ
        if (data && data.placement && data.placement.target) {
          const org = ORGAN_LOOKUP[data.placement.target];
          if (!org) {
            dispatchMessage('show-alert', { type: 'error', message: 'Please select another organ. We currently do not support the chosen organ.' });
          } else {
            rui.organ = org.rui;
          }
        }

        rui.editRegistration = data;
      }).finally(() => {
        dispatchMessage('iframe-data-ready');
      }).catch(err => {
        console.log('couldn\'t fetch the existing file');
        console.error(err);
      })
    }

    /**
     *
     * @param {string} type the message type
     * @param {object?} data the data (could be undefined)
     * @returns
     */
    const dispatchMessage = (type, content) => {
      if (!window.parent) {
        if (content.message) {
          console.log(content.message);
        }
        return;
      }
      window.parent.postMessage({ type: type, content: content }, window.location.origin);
    }


    /**
     * recieve messages
     */
    window.addEventListener('message', (event) => {
      if (event.origin !== window.location.origin) return;
      const type = event.data.type;
      const content = event.data.content;

      switch (type) {
        case 'initialize-iframe':
          configureRUI(content);
          break;
      }

    });

    // let the parent know that the iframe is loaded and ready to recieve messages
    window.addEventListener('DOMContentLoaded', () => {

      if (IN_IFRAME) {
        dispatchMessage('iframe-ready');
      } else {
        configureRUI();
      }
    });

  </script>
</body>

</html>
