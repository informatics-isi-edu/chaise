<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HuBMAP CCF Registration User Interface (CCF-RUI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link href="dist/rui/styles.css" rel="stylesheet">
  <script src="dist/rui/wc.js" async></script>
</head>
<body class="mat-typography">
  <ccf-rui></ccf-rui>

  <script>
    const configureRUI = (json) => {
      const rui = document.querySelector('ccf-rui');

      rui.useDownload = false;

      // TODO avoid hardcoding
      rui.baseHref = 'https://dev.isrd.isi.edu/~ashafaei/ccf-ui/dist/rui/';

      // TODO
      console.log(json);
	    fetch(json.data.url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Request failed');
          }
          return response.json();
          })
          .then(data => {
            rui.editRegistration = data;
          })
          .catch(error => {
            console.error(error);
          });
      
      // rui.user = {firstName: 'Jane', lastName: 'Doe'};
      // rui.organ = { name: 'kidney', side: 'left', sex: 'female' };
      // rui.editRegistration = sampleRegistration;

      // rui.fetchPreviousRegistrations = () => {
      //   return Promise.resolve([sampleRegistration]);
      // };
      // rui.cancelRegistration = () => {
      //   window.location.href = 'https://ingest.hubmapconsortium.org/'
      // };

      rui.register = (data) => {
	    const json = JSON.stringify(JSON.parse(data), null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      // Create a File object from the Blob
      const file = new File([blob], 'data.json', { type: 'application/json' });
      dispatchMessage('submit-data', file, data);
      }

    }

    /**
     *
     * @param {string} type the message type
     * @param {object?} data the data (could be undefined)
     * @returns
     */
    const dispatchMessage = (type, content, data) => {
      if (!window.parent) return;
      window.parent.postMessage({type: type, content: content, data: data}, window.location.origin);
    }


    /**
     * recieve messages
     */
    window.addEventListener('message', (event) => {
      if (event.origin !== window.location.origin) return;
      const type = event.data.type;
      const content = event.data.content;

      switch (type) {
        case 'initialize-iframe':
          configureRUI(event.data);
          break;
      }

    });

    // let the parent know that the iframe is loaded and ready to recieve messages
    window.addEventListener('DOMContentLoaded', () => {
      const inIframe = window.self !== window.parent;

      if (inIframe) {
        dispatchMessage('iframe-loaded');
      } else {
        configureRUI();
      }
    });

  </script>
</body>
</html>
