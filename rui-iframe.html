<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>HuBMAP CCF Registration User Interface (CCF-RUI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link href="dist/rui/styles.css" rel="stylesheet">
  <script src="dist/rui/wc.js" async></script>
</head>

<body class="mat-typography">
  <ccf-rui></ccf-rui>

  <script>
    const IN_IFRAME = window.self !== window.parent;

    const FIELD_NAMES = {
      FILE: 'registry_file',
      ID: 'registry_id',
      CREATOR: 'registry_creator'
    }

    // TODO https://github.com/informatics-isi-edu/atlas-d2k/issues/11
    const ORGAN_LOOKUP = {
      'http://purl.org/ccf/latest/ccf.owl#VHFRightKidney': {
        'name': 'kidney',
        'side': 'right',
        'sex': 'female'
      },
      'http://purl.org/ccf/latest/ccf.owl#VHMRightKidney': {
        'name': 'kidney',
        'side': 'right',
        'sex': 'male'
      }
    }

    /**
     * expected data structure of content:
     * {
     *  values
     * }
     */
    const configureRUI = (existingValue) => {
      const rui = document.querySelector('ccf-rui');

      let ruiPath = 'dist/rui/';
      if (!window.location.pathname.endsWith('/')) {
        ruiPath = '/' + ruiPath;
      }
      rui.baseHref = window.location.pathname + ruiPath;

      // hide the default header
      rui.header = false;

      rui.useDownload = !IN_IFRAME;
      if (IN_IFRAME) {
        rui.register = (data) => {
          const submittedData = {};
          const dataObject = JSON.parse(data);

          // turn the data into a file blob
          const blob = new Blob([JSON.stringify(dataObject, null, 2)], { type: 'application/json' });

          const file = new File([blob], 'registry.json', { type: 'application/json' });

          submittedData[FIELD_NAMES.FILE] = file;
          submittedData[FIELD_NAMES.ID] = dataObject['@id'];
          submittedData[FIELD_NAMES.CREATOR] = dataObject['creator'];

          // check the organ and make sure we're supporting it.
          let organID;
          if (dataObject['placement'] && dataObject['placement']['target']) {
            organID = dataObject['placement']['target'];
          }

          if (!(organID in ORGAN_LOOKUP)) {
            dispatchMessage('show-alert', {type: 'error', message: 'Please select another organ. We currently do not support the chosen organ.'});
            return;
          }

          dispatchMessage('submit-data', submittedData);
        }
      }

      /**
       * if a value is already selected, we should fetch the file and
       * get the json from it.
       *
       */
      if (existingValue && typeof existingValue[FIELD_NAMES.FILE] === 'string' && existingValue[FIELD_NAMES.FILE] !== '') {
        fetch(existingValue[FIELD_NAMES.FILE]).then(response => {
          if (response.ok) {
            return response.json();
          } else {
            console.log(response.body);
            throw new Erorr('couldn\'t fetch the file');
          }
        }).then(data => {
          // preselect the user info
          if (data && data.creator_first_name && data.creator_last_name) {
            rui.user = { firstName: data.creator_first_name, lastName: data.creator_last_name };
          }

          // preselect the organ
          if (data && data.placement && data.placement.target) {
            const org = ORGAN_LOOKUP[data.placement.target];
            if (!org) {
              // TODO what should we say? do we even support this?
              dispatchMessage('show-alert', {type: 'error', message: 'Please select another organ. We currently do not support the chosen organ.'});
            } else {
              rui.organ = org;
            }
          }

          rui.editRegistration = data;
        }).finally(() => {
          dispatchMessage('iframe-data-ready');
        }).catch(err => {
          console.log('couldn\'t fetch the existing file');
          console.error(err);
        })
      } else {
        dispatchMessage('iframe-data-ready');
      }
    }

    /**
     *
     * @param {string} type the message type
     * @param {object?} data the data (could be undefined)
     * @returns
     */
    const dispatchMessage = (type, content) => {
      if (!window.parent) return;
      window.parent.postMessage({ type: type, content: content }, window.location.origin);
    }


    /**
     * recieve messages
     */
    window.addEventListener('message', (event) => {
      if (event.origin !== window.location.origin) return;
      const type = event.data.type;
      const content = event.data.content;

      switch (type) {
        case 'initialize-iframe':
          configureRUI(content);
          break;
      }

    });

    // let the parent know that the iframe is loaded and ready to recieve messages
    window.addEventListener('DOMContentLoaded', () => {

      if (IN_IFRAME) {
        dispatchMessage('iframe-ready');
      } else {
        configureRUI();
      }
    });

  </script>
</body>

</html>
